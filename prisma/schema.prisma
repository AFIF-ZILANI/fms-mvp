// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Batches {
  id                    String                 @id @default(uuid())
  starting_date         DateTime               @default(now())
  expected_selling_date DateTime
  initial_quantity      Int
  init_chicks_avg_wt    Float
  breed                 BirdBreeds
  batch_id              String                 @unique
  status                BatchStatus            @default(RUNNING)
  phase                 Phase
  farm_code             String
  product_code          String
  sector_code           String
  created_at            DateTime               @default(now())
  updated_at            DateTime               @updatedAt
  batchSuppliers        BatchSuppliers[]
  Environment           EnvironmentRecords[]
  Medications           Medications[]
  Vaccination           Vaccinations[]
  weightRecords         WeightRecords[]
  batchHouseAllocations BatchHouseAllocation[]
  events                HouseEvents[]
  consumptions          Consumption[]
  expenses              Expense[]

  @@index([farm_code, sector_code, product_code, batch_id])
}

model BatchSuppliers {
  id               String    @id @default(uuid())
  batch_id         String
  supplier_id      String
  price_per_chicks Decimal   @db.Decimal(10, 2)
  quantity         Int // number of chicks from this supplier
  delivery_date    DateTime
  quality_score    Float
  batch            Batches   @relation(fields: [batch_id], references: [id], onDelete: Cascade)
  supplier         Suppliers @relation(fields: [supplier_id], references: [id], onDelete: Cascade)

  @@unique([batch_id, supplier_id]) // one row per supplier per batch
}

model HouseEvents {
  id            String    @id @default(uuid())
  batch_id      String?
  house_id      Int
  event_type    EventType
  quantity      Float
  unit          Units
  occurred_at   DateTime
  farm_date     DateTime  @db.Date
  created_by_id String
  batch         Batches?  @relation(fields: [batch_id], references: [id], onDelete: SetNull)
  house         Houses    @relation(fields: [house_id], references: [id], onDelete: Cascade)
  created_by    Profiles  @relation(fields: [created_by_id], references: [id], onDelete: Restrict)
}

model WeightRecords {
  id               String   @id @default(uuid())
  batch_id         String?
  batch            Batches? @relation(fields: [batch_id], references: [id], onDelete: SetNull)
  house_id         Int
  house            Houses   @relation(fields: [house_id], references: [id], onDelete: Cascade)
  average_wt_grams Decimal  @db.Decimal(10, 2)
  sample_size      Int
  date             DateTime
  farm_date        DateTime @db.Date
  measured_by_id   String
  measured_by      Profiles @relation(fields: [measured_by_id], references: [id], onDelete: Cascade)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@unique([batch_id, house_id, date])
}

model Houses {
  id         Int       @id @default(autoincrement())
  name       String // custom name like "Brooder 3"
  type       HouseType
  number     Int
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  weightRecords         WeightRecords[]
  batchHouseAllocations BatchHouseAllocation[]
  events                HouseEvents[]

  consumptions Consumption[]
}

model BatchHouseAllocation {
  id         String    @id @default(uuid())
  batch_id   String
  batch      Batches   @relation(fields: [batch_id], references: [id], onDelete: Cascade)
  house_id   Int
  house      Houses    @relation(fields: [house_id], references: [id], onDelete: Cascade)
  quantity   Int // number of chicks allocated to this house
  start_date DateTime
  end_date   DateTime? // null = currently in this house
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  @@index([batch_id, house_id])
}

model Profiles {
  id            String          @id @default(uuid())
  email         String?         @unique
  name          String
  mobile        String
  address       String?
  avatar_id     String?
  role          UserRole
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt
  // online_contact ContactMethods[]
  avatar        Avatars?        @relation(fields: [avatar_id], references: [id], onDelete: SetNull)
  employees     Employees?
  admins        Admins?
  customers     Customers?
  suppliers     Suppliers?
  pharmacists   Pharmacists?
  doctors       Doctors?
  houseEvents   HouseEvents[]
  weightRecords WeightRecords[]
}

model Employees {
  id           String            @id @default(uuid())
  profile_id   String            @unique
  profiles     Profiles          @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  salary       Float
  joining_date DateTime          @default(now())
  rating       Float?            @default(0)
  role         EmployeeRoleNames
  created_at   DateTime          @default(now())
  updated_at   DateTime          @updatedAt
}

model Admins {
  id          String         @id @default(uuid())
  profile_id  String         @unique
  profile     Profiles       @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  Medications Medications[]
  Vaccination Vaccinations[]
}

model Customers {
  id         String   @id @default(uuid())
  profile_id String   @unique
  profile    Profiles @relation(fields: [profile_id], references: [id])
  rating     Float?   @default(0)
  company    String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  Sale       Sale[]
}

model Suppliers {
  id             String                     @id @default(uuid())
  profile_id     String                     @unique
  profile        Profiles                   @relation(fields: [profile_id], references: [id])
  rating         Float?                     @default(0)
  role           SupplierRoleNames
  type           SupplierSupplyCategories[]
  company        String?
  created_at     DateTime                   @default(now())
  updated_at     DateTime                   @updatedAt
  Item           Item[]
  batchSuppliers BatchSuppliers[]
}

model Doctors {
  id          String         @id @default(uuid())
  specialty   String?
  position    String?
  degrees     String[]
  rating      Float?         @default(0)
  sector      String?
  institution String?
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  profile_id  String         @unique
  profile     Profiles       @relation(fields: [profile_id], references: [id])
  Medications Medications[]
  Vaccination Vaccinations[]
}

model Pharmacists {
  id            String   @id @default(uuid())
  rating        Float?   @default(0)
  institution   String?
  is_registered Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  profile_id    String   @unique
  profile       Profiles @relation(fields: [profile_id], references: [id])
}

model StockLedger {
  id         String         @id @default(uuid())
  itemId     String
  direction  StockDirection // IN | OUT | ADJUST
  quantity   Float
  unitCost   Float? // purchase or avg cost
  reason     StockReason // PURCHASE, CONSUMPTION, SALE, WASTAGE
  occurredAt DateTime
  ref_type   RefType // CONSUMPTION, SALE, PURCHASE
  ref_id     String? // points to domain record
  item       Item           @relation(fields: [itemId], references: [id])

  @@index([itemId, occurredAt])
}

model Item {
  id            String             @id @default(uuid())
  name          String
  category      ResourceCategories
  unit          Units
  meta_data     Json
  createdAt     DateTime           @default(now())
  ledgerEntries StockLedger[]
  suppliers     Suppliers[]
  consumptions  Consumption[]
  saleItems     SaleItem[]
}

model Consumption {
  id       String             @id @default(uuid())
  batchId  String
  houseId  Int
  itemId   String
  quantity Float
  purpose  ConsumptionPurpose
  date     DateTime

  batch Batches @relation(fields: [batchId], references: [id])
  house Houses  @relation(fields: [houseId], references: [id])
  item  Item    @relation(fields: [itemId], references: [id])

  @@index([batchId, houseId, date])
}

model Sale {
  id         String   @id @default(uuid())
  customerId String?
  date       DateTime
  total      Float

  items SaleItem[]

  customers Customers[]
}

model SaleItem {
  id        String @id @default(uuid())
  saleId    String
  itemId    String
  quantity  Float
  unitPrice Float

  sale Sale @relation(fields: [saleId], references: [id])
  item Item @relation(fields: [itemId], references: [id])

  @@index([saleId, itemId])
}

model Expense {
  id       String          @id @default(uuid())
  batchId  String?
  category ExpenseCategory // LABOR, ELECTRICITY, TRANSPORT
  amount   Float
  date     DateTime
  remarks  String?

  batch Batches? @relation(fields: [batchId], references: [id])
}

model Medications {
  id                 String    @id @default(uuid())
  batch_id           String
  date               DateTime  @default(now())
  medication_details String
  administered_by    String
  medicine_name      String
  dosage             String
  cause              String?
  period             String?
  doctor_id          String?
  remarks            String?
  farm_date          DateTime? @db.Date
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  administered       Admins    @relation(fields: [administered_by], references: [id])
  batch              Batches   @relation(fields: [batch_id], references: [id])
  doctor             Doctors?  @relation(fields: [doctor_id], references: [id])
}

model Vaccinations {
  id              String    @id @default(uuid())
  batch_id        String
  date            DateTime  @default(now())
  vaccine_details String?
  administered_by String
  vaccine_name    String
  dosage          Int
  cause           String?
  period          String?
  doctor_id       String?
  remarks         String?
  farm_date       DateTime? @db.Date
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  administered    Admins    @relation(fields: [administered_by], references: [id])
  batch           Batches   @relation(fields: [batch_id], references: [id])
  doctor          Doctors?  @relation(fields: [doctor_id], references: [id])
}

model EnvironmentRecords {
  id               String      @id @default(uuid())
  batch_id         String
  house_no         Int
  temperature_c    Float
  humidity_percent Float
  ammonia_ppm      Float
  co2_ppm          Float
  air_pressure_hpa Float
  farm_date        DateTime?   @db.Date
  time_period      TimePeriods
  recorded_at      DateTime    @default(now())
  batch            Batches     @relation(fields: [batch_id], references: [id])
}

model Avatars {
  id         String     @id @default(uuid())
  public_id  String
  image_url  String
  created_at DateTime   @default(now())
  profiles   Profiles[]
}

model Alerts {
  id          String            @id @default(uuid())
  title       String
  description String?
  type        AlertTypes // e.g. "employee", "batch", "finance"
  level       AlertLevels // e.g. "info" | "warning" | "critical"
  status      AlertStatus       @default(ACTIVE) // active | resolved
  related_id  String? // link to employee_id, batch_id, etc.
  action_type AlertActionTypes? // pay | assign | mark_resolved etc.
  created_at  DateTime          @default(now())
  issued_at   DateTime?         @db.Date
  resolved_at DateTime?         @db.Date
}

enum EmployeeRoleNames {
  MANAGER
  WORKER
  INTERN
}

enum ContactMethods {
  WHATSAPP
  EMAIL
  IMO
  TELEGRAM
}

enum SupplierRoleNames {
  SALES_MAN
  OWNER
  DISTRIBUTOR
  DEALER
  WHOLESALER
  RETAILER
  MANUFACTURER
  IMPORTER
  REPRESENTATIVE
}

enum TransactionTypes {
  PURCHASE
  SALE
  RETURN
  ADJUSTMENT
  DAMAGE
}

enum Units {
  BIRD
  KG
  LITER
  BAG
  BOX
  UNIT
  OTHER
}

enum TimePeriods {
  MORNING
  NOON
  AFTERNOON
  EVENING
  NIGHT
  MIDNIGHT
  LATENIGHT
}

enum BirdBreeds {
  CLASSIC
  HIBREED
  PAKISTHANI
  KEDERNATH
  FAOMI
  TIGER
}

enum ResourceCategories {
  FEED
  MEDICINE
  CHICKS
  HUSK
  EQUIPMENT
  UTILITIES
  SALARY
  TRANSPORTATION
  MAINTENANCE
  CLEANING_SUPPLIES
  OTHER
}

enum SupplierSupplyCategories {
  FEED
  MEDICINE
  CHICKS
  HUSK
  EQUIPMENT
  UTILITIES
  TRANSPORTATION
  CLEANING_SUPPLIES
  OFFICE_SUPPLIES
  SOFTWARE
  OTHER
}

enum AlertTypes {
  EMPLOYEE
  BATCH
  FEED
  MEDICINE
  SYSTEM
}

enum AlertLevels {
  INFO
  WARNING
  CRITICAL
}

enum AlertStatus {
  ACTIVE
  RESOLVED
}

enum AlertActionTypes {
  PAY
  REASSIGN
  MARK_RESOLVED
}

enum HouseType {
  BROODER
  GROWER
}

enum BatchStatus {
  RUNNING
  CLOSED
  SOLD
}

enum Phase {
  BROODER
  GROWER
}

enum UserRole {
  ADMIN
  EMPLOYEE
  CUSTOMER
  SUPPLIER
  PHARMACIST
  DOCTOR
}

enum EventType {
  FEED
  WATER
  MORTALITY
}

enum StockDirection {
  IN
  OUT
  ADJUST
}

enum StockReason {
  PURCHASE
  CONSUMPTION
  SALE
  WASTAGE
  EXPIRED
  RETURN
}

enum ExpenseCategory {
  LABOR
  ELECTRICITY
  TRANSPORT
  INTERNET
}

enum ConsumptionPurpose {
  FEED // daily feeding
  MEDICINE // therapeutic treatment
  VACCINE // scheduled vaccination
  SUPPLEMENT // vitamins, minerals, probiotics
  LITTER // husk, sawdust, bedding, insulation
}

enum RefType {
  CONSUMPTION
  SALE
  PURCHASE
}
